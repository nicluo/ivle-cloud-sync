{% extends "layout.html" %}
{% block title %}Settings - IVLE Cloud Sync{% endblock %}
{% block body %}
<div data-role="header">
  <h1>Settings</h1>
</div>

<div class="center" data-role="content">
  <a href="https://www.dropbox.com/"><img src="{{ url_for('static', filename='img/pe-web.png') }}"></a><br>
  {% if not user.dropbox_key %}
  Connect with Dropbox to sync your Workbin files.<br>
  <a data-inline="true" data-role="button" rel="external"
     href="{{ url_for('dropbox_login') }}">Connect with Dropbox</a>
  {% else %}
  You are connected with Dropbox. Your Workbin files will be synced.<br>
  <a data-inline="true" data-role="button"
     href="{{ url_for('dropbox_logout') }}">Disconnect from Dropbox</a>
  {% endif %}
  <br><br>
  {% if modules.values() %}
    <h2>Folders to Sync</h2>
    <form method="post" action="{{ url_for('settings') }}">
      {% for module in modules.values() %}
      <fieldset data-role="controlgroup">
        {% for directory in module %}
        <label data-nest="{{ directory['nesting_level'] }}">
          <input type="checkbox" data-mini="true" value="{{ directory['id'] }}"
                 name="{{ directory['id'] }}" {% if directory['sync'] %}checked{% endif %} />
          {{ directory['directory'] }}
        </label>
        {% endfor %}
      </fieldset>
      {% endfor %}
      <button data-inline="true" type="submit" name="submit" value="submit">Submit</button>
    </form>
  {% else %}
    <h2>Hold It Right There!</h2>
    <h2>We are rushing to get your files from IVLE.</h2>
    <p>Please wait....</p>
    <div>
      <img  style="min-width:200px;max-width:600px;" src="{{url_for('static', filename='settings-img/wait.png' )}}" alt="Wait for your files!">
    </div>
    <script>
      $(document).ready(function(){
        setTimeout(function(){ location.reload(); }, 7000);
      })
    </script>
  {% endif %}
</div>

<script>
  function updateAncestors(el, checked, nestingLevel) {
    var all = true;
    var parent;
    el.prevAll().each(function() {
      if ($(this).children('.ui-btn').data('nest') === nestingLevel - 1) {
        parent = $(this);
        return false;
      }
      all = $(this).children('input[type="checkbox"]').prop('checked') === checked;
      return all;
    });
    if (all) {
      el.nextAll().each(function() {
        if ($(this).children('.ui-btn').data('nest') === nestingLevel - 1) {
          return false;
        }
        all = $(this).children('input[type="checkbox"]').prop('checked') === checked;
        return all;
      });
    }
    if (all) {
      if (parent) {
        parent.children('input[type="checkbox"]').prop('checked', checked).checkboxradio('refresh');
        updateAncestors(parent, checked, nestingLevel - 1);
      }
    } else {
      el.prevAll().each(function() {
        if ($(this).children('.ui-btn').data('nest') === nestingLevel - 1) {
          nestingLevel -= 1;
          $(this).children('input[type="checkbox"]').prop('checked', false).checkboxradio('refresh');
        }
      });
    }
  }

  $('input[type="checkbox"]').click(function() {
    var checked = $(this).prop('checked');
    var nestingLevel = $(this).parent().children('.ui-btn').data('nest');
    $(this).parent().nextAll().each(function() {
      if ($(this).children('.ui-btn').data('nest') == nestingLevel) {
          return false;
      }
      $(this).children('input[type="checkbox"]').prop('checked', checked).checkboxradio('refresh');
    });
    updateAncestors($(this).parent(), checked, nestingLevel);
  });
</script>
{% endblock %}
